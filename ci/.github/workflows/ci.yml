name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  ZEPHYR_VERSION: v3.5.0
  ZEPHYR_SDK_VERSION: 0.16.5

jobs:
  build-firmware:
    name: Build Firmware
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app:
          - name: stm32n6_app
            board: qemu_cortex_m3
          - name: stm32wl_driver
            board: qemu_cortex_m4
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Cache Zephyr SDK
        uses: actions/cache@v3
        with:
          path: ~/zephyr-sdk
          key: ${{ runner.os }}-zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }}
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build gperf ccache dfu-util \
            device-tree-compiler wget python3-dev python3-pip \
            python3-setuptools python3-tk python3-wheel xz-utils \
            file make gcc gcc-multilib g++-multilib libsdl2-dev \
            libmagic1
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install West
        run: |
          pip3 install --user west
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Initialize Zephyr Workspace
        run: |
          west init -m https://github.com/zephyrproject-rtos/zephyr --mr ${{ env.ZEPHYR_VERSION }} zephyrproject
          cd zephyrproject
          west update
          west zephyr-export
          pip3 install --user -r zephyr/scripts/requirements.txt
      
      - name: Install Zephyr SDK
        run: |
          if [ ! -d ~/zephyr-sdk ]; then
            cd ~
            wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v${{ env.ZEPHYR_SDK_VERSION }}/zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }}_linux-x86_64.tar.xz
            tar xf zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }}_linux-x86_64.tar.xz
            mv zephyr-sdk-${{ env.ZEPHYR_SDK_VERSION }} zephyr-sdk
            cd zephyr-sdk
            ./setup.sh -t all -h -c
          fi
          echo "ZEPHYR_SDK_INSTALL_DIR=$HOME/zephyr-sdk" >> $GITHUB_ENV
      
      - name: Build Application
        run: |
          cd zephyrproject/zephyr
          west build -p auto -b ${{ matrix.app.board }} \
            ../../firmware/zephyr-apps/${{ matrix.app.name }}
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: firmware-${{ matrix.app.name }}-${{ matrix.app.board }}
          path: |
            zephyrproject/zephyr/build/zephyr/zephyr.elf
            zephyrproject/zephyr/build/zephyr/zephyr.bin
            zephyrproject/zephyr/build/zephyr/zephyr.hex

  test-qemu:
    name: Test in QEMU
    runs-on: ubuntu-latest
    needs: build-firmware
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Install QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-arm
      
      - name: Download Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: firmware-stm32n6_app-qemu_cortex_m3
          path: build/
      
      - name: Run QEMU Test
        run: |
          echo "QEMU test placeholder - implement actual tests"
          # qemu-system-arm -machine ... -kernel build/zephyr.elf -nographic
      
  lint-python:
    name: Lint Python Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          pip install flake8 black
      
      - name: Run Flake8
        run: |
          flake8 analysis/*.py --max-line-length=100
      
      - name: Run Black
        run: |
          black --check analysis/*.py

  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Check Markdown Files
        run: |
          find . -name "*.md" -type f
          echo "Documentation check passed"
  
  paper-results:
    name: Generate IEEE Paper Results
    runs-on: ubuntu-latest
    needs: build-firmware
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Python Dependencies
        run: |
          pip install numpy matplotlib scipy pandas
      
      - name: Download Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: firmware-stm32n6_app-qemu_cortex_m3
          path: build/
      
      - name: Generate All Paper Results
        run: |
          cd analysis
          python3 generate_paper_results.py --output-dir ../paper_results
      
      - name: Upload Paper Results
        uses: actions/upload-artifact@v3
        with:
          name: ieee-paper-results
          path: |
            paper_results/results/*.json
            paper_results/latex_fragments/*.tex
            paper_results/figures/*.pdf
            paper_results/RESULTS_SUMMARY.md
      
      - name: Generate Results Report
        run: |
          echo "# IEEE Paper Results Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Files Generated:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### LaTeX Fragments" >> $GITHUB_STEP_SUMMARY
          ls paper_results/latex_fragments/*.tex | xargs -I {} basename {} >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Figures" >> $GITHUB_STEP_SUMMARY
          ls paper_results/figures/*.pdf 2>/dev/null | xargs -I {} basename {} >> $GITHUB_STEP_SUMMARY || echo "No figures generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download artifacts to populate IEEE paper placeholders." >> $GITHUB_STEP_SUMMARY
