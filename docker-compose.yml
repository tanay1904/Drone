version: '3.8'

services:
  # Redis for session management and pub/sub
  redis:
    image: redis:7-alpine
    container_name: drone-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    networks:
      - drone-network

  # MQTT Broker (Mosquitto)
  mqtt:
    image: eclipse-mosquitto:latest
    container_name: drone-mqtt
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mqtt-data:/mosquitto/data
      - mqtt-logs:/mosquitto/log
    networks:
      - drone-network

  # WebRTC TURN Server (coturn)
  turn:
    image: coturn/coturn:latest
    container_name: drone-turn
    ports:
      - "3478:3478/udp"
      - "3478:3478/tcp"
      - "5349:5349/udp"
      - "5349:5349/tcp"
      - "49152-49200:49152-49200/udp"
    environment:
      - DETECT_EXTERNAL_IP=yes
      - EXTERNAL_IP=${EXTERNAL_IP:-auto}
      - LISTENING_PORT=3478
      - RELAY_IP=${RELAY_IP:-auto}
      - RELAY_PORT_MIN=49152
      - RELAY_PORT_MAX=49200
      - CLI_PASSWORD=drone123
    command: |
      -n
      --log-file=stdout
      --listening-port=3478
      --realm=drone.local
      --fingerprint
      --lt-cred-mech
      --user=drone:dronepass
    networks:
      - drone-network

  # TimescaleDB for telemetry storage
  timescale:
    image: timescale/timescaledb:latest-pg15
    container_name: drone-timescale
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=drone_telemetry
      - POSTGRES_USER=drone_user
      - POSTGRES_PASSWORD=drone_pass
    volumes:
      - timescale-data:/var/lib/postgresql/data
      - ./config/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - drone-network

  # Grafana for telemetry visualization
  grafana:
    image: grafana/grafana:latest
    container_name: drone-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-worldmap-panel
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./config/grafana/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - timescale
    networks:
      - drone-network

  # Nginx for reverse proxy and load balancing
  nginx:
    image: nginx:alpine
    container_name: drone-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf
      - ./config/ssl:/etc/nginx/ssl
      - ./frontend/build:/usr/share/nginx/html
    depends_on:
      - backend-primary
      - backend-secondary
    networks:
      - drone-network

  # Primary backend server
  backend-primary:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: drone-backend-primary
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - REDIS_HOST=redis
      - MQTT_HOST=mqtt
      - MQTT_PORT=1883
      - DB_HOST=timescale
      - DB_USER=drone_user
      - DB_PASSWORD=drone_pass
      - DB_NAME=drone_telemetry
      - TURN_SERVER=turn:3478
      - TURN_USER=drone
      - TURN_PASS=dronepass
      - SERVER_ID=primary
      - ENABLE_CELLULAR=false
    volumes:
      - ./backend:/app
      - /app/node_modules
    depends_on:
      - redis
      - mqtt
      - timescale
    networks:
      - drone-network
    devices:
      - /dev/ttyACM0:/dev/ttyACM0  # STM32 serial port
      - /dev/ttyUSB0:/dev/ttyUSB0  # Cellular modem

  # Secondary backend server (for failover)
  backend-secondary:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: drone-backend-secondary
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - PORT=3002
      - REDIS_HOST=redis
      - MQTT_HOST=mqtt
      - MQTT_PORT=1883
      - DB_HOST=timescale
      - DB_USER=drone_user
      - DB_PASSWORD=drone_pass
      - DB_NAME=drone_telemetry
      - TURN_SERVER=turn:3478
      - TURN_USER=drone
      - TURN_PASS=dronepass
      - SERVER_ID=secondary
      - ENABLE_CELLULAR=false
    volumes:
      - ./backend:/app
      - /app/node_modules
    depends_on:
      - redis
      - mqtt
      - timescale
    networks:
      - drone-network

  # Edge server (for low latency)
  backend-edge:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: drone-backend-edge
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
      - PORT=3003
      - REDIS_HOST=redis
      - MQTT_HOST=mqtt
      - SERVER_ID=edge
      - ENABLE_CELLULAR=true
    volumes:
      - ./backend:/app
      - /app/node_modules
    depends_on:
      - redis
      - mqtt
    networks:
      - drone-network
    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0  # Cellular modem

  # Prometheus for monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: drone-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - drone-network

  # Video streaming server (Janus WebRTC Gateway)
  janus:
    image: canyan/janus-gateway:latest
    container_name: drone-janus
    ports:
      - "8088:8088"
      - "8089:8089"
      - "8889:8889"
      - "8000:8000"
      - "7088:7088"
      - "7089:7089"
    volumes:
      - ./config/janus:/etc/janus
    networks:
      - drone-network

networks:
  drone-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  redis-data:
  mqtt-data:
  mqtt-logs:
  timescale-data:
  grafana-data:
  prometheus-data: